name: Python C Extension Test with Coverage

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install scikit-build-core cmake

    - name: Install lcov
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov

    - name: Configure and build the C extension
      run: |
        # Set environment variables for compiler and linker flags
        export CFLAGS="-g -fprofile-arcs -ftest-coverage"
        export LDFLAGS="-fprofile-arcs -ftest-coverage"
        # Build the project
        CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Debug" pip install .  --target .
        export PYTHONPATH=$(pwd)
        echo $PYTHONPATH

    - name: Install test dependencies
      run: |
        python -m pip install numpy pytest

    - name: Run pytest
      run: |
        pytest test/test_rstatspy.py

    - name: Build and run the C executable to generate coverage data
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug \
              -DCMAKE_C_FLAGS="--coverage" \
              -DCMAKE_EXE_LINKER_FLAGS="--coverage"
        cmake --build build
        cd build
        cp ../test/test_rstatspy.py .
        ./test_rstatspy test_rstatspy.py
        lcov --capture --directory . \
        --directory /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/ \
        --output-file coverage.info 
        lcov --remove coverage.info '/usr/*' --output-file coverage.info  # Remove coverage for system files.
        lcov --list coverage.info

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: build/coverage.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        codecov_yml_path: .github/codecov.yml